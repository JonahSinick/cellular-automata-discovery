<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Color Cellular Automata</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #00d4ff; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 10px; font-size: 14px; }
        .nav { text-align: center; margin-bottom: 20px; }
        .nav a { color: #666; text-decoration: none; font-size: 13px; }
        .main-layout { display: flex; gap: 20px; flex-wrap: wrap; }
        .canvas-container {
            flex: 1; min-width: 450px;
            background: #0f0f1a; border-radius: 12px; padding: 15px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        canvas { border: 2px solid #333; border-radius: 4px; }
        .controls {
            width: 300px; background: #16213e;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .control-group { margin-bottom: 18px; }
        .control-group label {
            display: block; margin-bottom: 8px; color: #888;
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
        }
        input[type="range"] { width: 100%; margin: 5px 0; }
        .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        button {
            flex: 1; min-width: 70px; padding: 12px 14px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #00a8cc); color: #000; }
        .btn-secondary { background: #333; color: #eee; }
        .btn-danger { background: linear-gradient(135deg, #e94560, #c73e54); color: #fff; }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .preset-grid button { font-size: 11px; padding: 10px 6px; }
        .featured { background: linear-gradient(135deg, #00d4ff, #00a8cc) !important; color: #000 !important; }
        .stats {
            background: #0f0f1a; border-radius: 6px; padding: 12px;
            font-family: monospace; font-size: 12px;
        }
        .stats div { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .stats span:first-child { color: #666; }
        .stats span:last-child { color: #00d4ff; }
        .color-bar { display: flex; gap: 4px; margin-top: 8px; }
        .color-swatch { flex: 1; height: 20px; border-radius: 3px; }
        .section-title {
            color: #00d4ff; font-size: 11px; margin: 15px 0 8px 0;
            padding-bottom: 4px; border-bottom: 1px solid #333;
        }
        select {
            width: 100%; padding: 10px; border: 1px solid #333;
            border-radius: 6px; background: #0f0f1a; color: #eee; font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>3-Color Cellular Automata</h1>
        <p class="subtitle">Discovered patterns: Baroque Curls, Geometric Mazes, Smooth Flow</p>
        <p class="nav"><a href="index.html">← 2-state</a> · <a href="multistate.html">Multi-state →</a></p>

        <div class="main-layout">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Discovered Patterns</label>
                    <div class="preset-grid">
                        <button class="btn-secondary featured" onclick="setPreset('baroque')">Baroque Curls</button>
                        <button class="btn-secondary" onclick="setPreset('maze')">Geo Mazes</button>
                        <button class="btn-secondary" onclick="setPreset('smooth')">Smooth Flow</button>
                        <button class="btn-secondary" onclick="setPreset('swirls')">Paisley</button>
                        <button class="btn-secondary" onclick="setPreset('diagonal')">Diagonal</button>
                        <button class="btn-secondary" onclick="setPreset('cyclic3')">Classic T3</button>
                    </div>
                </div>

                <div class="section-title">Rule Type</div>
                <div class="control-group">
                    <select id="ruleType" onchange="updateRule()">
                        <option value="cyclic">Cyclic</option>
                        <option value="chase">Chase & Flee</option>
                        <option value="range2">Range-2 Cyclic</option>
                        <option value="diagonal">Diagonal Only</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Threshold: <span id="thresholdValue">3</span></label>
                    <input type="range" id="thresholdSlider" min="1" max="8" value="3">
                </div>

                <div class="control-group" id="fleeGroup">
                    <label>Flee Threshold: <span id="fleeValue">5</span></label>
                    <input type="range" id="fleeSlider" min="2" max="7" value="5">
                </div>

                <div class="control-group">
                    <label>Speed: <span id="speedValue">15</span> gen/s</label>
                    <input type="range" id="speedSlider" min="1" max="60" value="15">
                </div>

                <div class="section-title">Controls</div>
                <div class="control-group buttons">
                    <button id="playBtn" class="btn-primary" onclick="togglePlay()">Play</button>
                    <button class="btn-secondary" onclick="step()">Step</button>
                    <button class="btn-danger" onclick="reset()">Reset</button>
                </div>

                <div class="control-group">
                    <label>Colors</label>
                    <div class="color-bar">
                        <div class="color-swatch" style="background:#141420"></div>
                        <div class="color-swatch" style="background:#00d4ff"></div>
                        <div class="color-swatch" style="background:#ff6b6b"></div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="stats">
                        <div><span>Generation:</span><span id="genStat">0</span></div>
                        <div><span>Rule:</span><span id="ruleStat">Chase C3F5</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const palette = ['#141420', '#00d4ff', '#ff6b6b'];

        let gridSize = 150;
        let cellSize = 4;
        let grid = [];
        let running = false;
        let generation = 0;
        let intervalId = null;
        let speed = 15;

        let ruleType = 'chase';
        let threshold = 3;
        let fleeThreshold = 5;

        function initCanvas() {
            canvas.width = gridSize * cellSize;
            canvas.height = gridSize * cellSize;
        }

        function initGrid() {
            grid = [];
            for (let y = 0; y < gridSize; y++) {
                grid[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    grid[y][x] = Math.floor(Math.random() * 3);
                }
            }
            generation = 0;
        }

        function countNeighborsState(x, y, state, range = 1) {
            let count = 0;
            for (let dy = -range; dy <= range; dy++) {
                for (let dx = -range; dx <= range; dx++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = (x + dx + gridSize) % gridSize;
                    const ny = (y + dy + gridSize) % gridSize;
                    if (grid[ny][nx] === state) count++;
                }
            }
            return count;
        }

        function countDiagonalNeighbors(x, y, state) {
            let count = 0;
            for (const [dy, dx] of [[-1,-1], [-1,1], [1,-1], [1,1]]) {
                const nx = (x + dx + gridSize) % gridSize;
                const ny = (y + dy + gridSize) % gridSize;
                if (grid[ny][nx] === state) count++;
            }
            return count;
        }

        function step() {
            const newGrid = [];
            for (let y = 0; y < gridSize; y++) {
                newGrid[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    const current = grid[y][x];
                    const next = (current + 1) % 3;
                    const prev = (current + 2) % 3;
                    let advance = false;

                    if (ruleType === 'cyclic') {
                        const nextN = countNeighborsState(x, y, next);
                        advance = nextN >= threshold;
                    } else if (ruleType === 'chase') {
                        const nextN = countNeighborsState(x, y, next);
                        const prevN = countNeighborsState(x, y, prev);
                        advance = nextN >= threshold && prevN < fleeThreshold;
                    } else if (ruleType === 'range2') {
                        const nextN = countNeighborsState(x, y, next, 2);
                        advance = nextN >= threshold;
                    } else if (ruleType === 'diagonal') {
                        const nextN = countDiagonalNeighbors(x, y, next);
                        advance = nextN >= threshold;
                    }

                    newGrid[y][x] = advance ? next : current;
                }
            }
            grid = newGrid;
            generation++;
            render();
            updateStats();
        }

        function render() {
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const state = grid[y][x];
                    const color = hexToRgb(palette[state]);
                    for (let cy = 0; cy < cellSize; cy++) {
                        for (let cx = 0; cx < cellSize; cx++) {
                            const idx = ((y * cellSize + cy) * canvas.width + (x * cellSize + cx)) * 4;
                            data[idx] = color.r;
                            data[idx + 1] = color.g;
                            data[idx + 2] = color.b;
                            data[idx + 3] = 255;
                        }
                    }
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 255, g: 255, b: 255};
        }

        function updateStats() {
            document.getElementById('genStat').textContent = generation;
            let ruleName = ruleType === 'chase' ? `Chase C${threshold}F${fleeThreshold}` :
                          ruleType === 'range2' ? `Range2 T${threshold}` :
                          ruleType === 'diagonal' ? `Diag T${threshold}` :
                          `Cyclic T${threshold}`;
            document.getElementById('ruleStat').textContent = ruleName;
        }

        function updateRule() {
            ruleType = document.getElementById('ruleType').value;
            document.getElementById('fleeGroup').style.display = ruleType === 'chase' ? 'block' : 'none';

            // Adjust threshold ranges
            const slider = document.getElementById('thresholdSlider');
            if (ruleType === 'range2') {
                slider.max = 15;
                if (threshold < 6) { threshold = 8; slider.value = 8; }
            } else if (ruleType === 'diagonal') {
                slider.max = 4;
                if (threshold > 4) { threshold = 2; slider.value = 2; }
            } else {
                slider.max = 8;
            }
            document.getElementById('thresholdValue').textContent = threshold;
        }

        function togglePlay() {
            running = !running;
            document.getElementById('playBtn').textContent = running ? 'Pause' : 'Play';
            if (running) {
                intervalId = setInterval(step, 1000 / speed);
            } else if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function reset() {
            running = false;
            document.getElementById('playBtn').textContent = 'Play';
            if (intervalId) { clearInterval(intervalId); intervalId = null; }
            initGrid();
            render();
            updateStats();
        }

        function setPreset(name) {
            const presets = {
                'baroque':  { type: 'chase', thresh: 3, flee: 5 },
                'maze':     { type: 'chase', thresh: 2, flee: 5 },
                'smooth':   { type: 'range2', thresh: 10, flee: 5 },
                'swirls':   { type: 'cyclic', thresh: 3, flee: 5 },
                'diagonal': { type: 'diagonal', thresh: 2, flee: 5 },
                'cyclic3':  { type: 'cyclic', thresh: 3, flee: 5 },
            };
            const p = presets[name];
            if (p) {
                ruleType = p.type;
                threshold = p.thresh;
                fleeThreshold = p.flee;
                document.getElementById('ruleType').value = ruleType;
                document.getElementById('thresholdSlider').value = threshold;
                document.getElementById('fleeSlider').value = fleeThreshold;
                document.getElementById('thresholdValue').textContent = threshold;
                document.getElementById('fleeValue').textContent = fleeThreshold;
                updateRule();
                reset();
            }
        }

        // Event listeners
        document.getElementById('thresholdSlider').addEventListener('input', (e) => {
            threshold = parseInt(e.target.value);
            document.getElementById('thresholdValue').textContent = threshold;
        });

        document.getElementById('fleeSlider').addEventListener('input', (e) => {
            fleeThreshold = parseInt(e.target.value);
            document.getElementById('fleeValue').textContent = fleeThreshold;
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
            if (running) {
                clearInterval(intervalId);
                intervalId = setInterval(step, 1000 / speed);
            }
        });

        // Initialize
        initCanvas();
        updateRule();
        reset();
    </script>
</body>
</html>
